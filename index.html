<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>KSP Tracker Test</title>
<style>
html,body {margin:0; height:100%; overflow:hidden; background:#000; color:#fff; font-family:sans-serif;}
#timeLabel {position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.6); padding:6px 10px; border-radius:6px;}
</style>
</head>
<body>
<div id="timeLabel">UTC: <span id="utcTime">â€”</span></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.141.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.141.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.141.0/examples/js/renderers/CSS2DRenderer.js"></script>

<script>
try {
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1e8);
  camera.position.set(0,0,5e7);

  const renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.05;

  // CSS2DRenderer for labels
  const labelRenderer = new THREE.CSS2DRenderer();
  labelRenderer.setSize(window.innerWidth, window.innerHeight);
  labelRenderer.domElement.style.position = 'absolute';
  labelRenderer.domElement.style.top = '0';
  labelRenderer.domElement.style.pointerEvents = 'none';
  document.body.appendChild(labelRenderer.domElement);

  const light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(5e7,5e7,5e7);
  scene.add(light);

  // Planets
  const loader = new THREE.TextureLoader();
  const planetTextures = { Earth: 'earth.jpg', Moon: 'moon.png', Mars: 'mars.jpg' };
  const planetRadii = { Earth: 6371e3, Moon: 1737e3, Mars: 3389e3 };
  let planetMesh;
  let currentPlanet = 'Earth';

  function createPlanet(name) {
    if(planetMesh) scene.remove(planetMesh);
    const geometry = new THREE.SphereGeometry(planetRadii[name], 64, 64);
    const material = new THREE.MeshPhongMaterial({ map: loader.load(planetTextures[name]) });
    planetMesh = new THREE.Mesh(geometry, material);
    scene.add(planetMesh);
  }
  createPlanet(currentPlanet);

  // Load vessels.json
  let vessels = [];
  fetch('vessels.json').then(res => res.json()).then(data => {
    vessels = data.map(v => {
      // Small white sphere indicator
      const geom = new THREE.SphereGeometry(1e6, 8, 8);
      const mat = new THREE.MeshBasicMaterial({color:0xffffff});
      const mesh = new THREE.Mesh(geom, mat);
      scene.add(mesh);

      // Name label
      const div = document.createElement('div');
      div.textContent = v.info.name;
      div.style.color = 'white';
      div.style.fontSize = '12px';
      const label = new THREE.CSS2DObject(div);
      mesh.add(label);

      // Orbit line (compute simple Keplerian orbit points)
      const points = [];
      const segments = 200;
      for(let j=0;j<=segments;j++){
        const M = 2*Math.PI*j/segments;
        const E = M; // simple circular approximation
        const x = v.a*(Math.cos(E)-v.e);
        const y = v.a*Math.sqrt(1-v.e*v.e)*Math.sin(E);
        const z = 0;

        // Apply inclination
        const iRad = THREE.MathUtils.degToRad(v.i);
        const cosI = Math.cos(iRad), sinI = Math.sin(iRad);
        const y2 = y*cosI - z*sinI;
        const z2 = y*sinI + z*cosI;

        points.push(new THREE.Vector3(x,y2,z2));
      }
      const orbitGeom = new THREE.BufferGeometry().setFromPoints(points);
      const orbitLine = new THREE.Line(orbitGeom, new THREE.LineBasicMaterial({color:0xffffff, opacity:0.5, transparent:true}));
      scene.add(orbitLine);

      return {...v, mesh, orbitLine};
    });
  });

  // Animate
  function animate(){
    requestAnimationFrame(animate);

    // Earth spins once per 24h
    const secondsInDay = 24*60*60;
    const rotationPerFrame = (2*Math.PI) / (secondsInDay * 60); // ~60fps
    if(currentPlanet==='Earth') planetMesh.rotation.y += rotationPerFrame;
    else planetMesh.rotation.y += 0.001;

    // Update UTC
    document.getElementById('utcTime').textContent =
      new Date().toISOString().replace('T',' ').replace('Z',' UTC');

    controls.update();
    renderer.render(scene, camera);
    labelRenderer.render(scene, camera);
  }

  animate();

  window.addEventListener('resize', ()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
    labelRenderer.setSize(window.innerWidth, window.innerHeight);
  });
} catch (err) {
  console.error("Error in script:", err);
  document.body.innerHTML = "<h1 style='color:red'>JS ERROR</h1><pre>"+err+"</pre>";
}
</script>
</body>
</html>
