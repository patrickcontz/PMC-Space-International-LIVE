<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>KSP Tracker Final Fixed</title>
<style>
  html, body {margin:0; height:100%; overflow:hidden; background:#000; color:#fff; font-family:sans-serif;}
  #timeLabel {position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.6); padding:6px 10px; border-radius:6px;}
  #planetSelector {position:absolute; top:50px; left:10px; background:rgba(0,0,0,0.6); padding:6px 10px; border-radius:6px;}
  .label {color:white; font-size:12px; position:absolute; pointer-events:none; white-space: nowrap;}
  #infoPanel {position:absolute; left:0; top:100px; width:200px; background:rgba(0,0,0,0.8); padding:10px; border-radius:6px; display:none;}
  #infoPanel a {color:cyan; text-decoration:none;}
</style>
</head>
<body>
<div id="timeLabel">UTC: <span id="utcTime">â€”</span></div>
<div id="planetSelector">
  <select id="planetDropdown">
    <option value="earth">Earth</option>
    <option value="moon">Moon</option>
    <option value="mars">Mars</option>
  </select>
</div>
<div id="infoPanel">
  <div id="vesselName"></div>
  <div id="vesselDesc"></div>
  <a id="vesselYT" target="_blank">YouTube</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.141.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.141.0/examples/js/controls/OrbitControls.js"></script>

<script>
// --- Planet textures ---
const planetTextures = {
  earth: 'earth.jpg',
  moon: 'moon.png',
  mars: 'mars.jpg'
};

// --- Vessels JSON ---
const vessels = [
  {
    "id":"iss_recreation",
    "type":"keplerian",
    "centralBody":"earth",
    "epoch": 1737176400,
    "a": 6771000,
    "e": 0.0005,
    "i": 51.64 * Math.PI/180,
    "raan": 0,
    "argPeri": 0,
    "M0": 0,
    "info": {"name":"ISS Recreation","description":"International Space Station recreated in KSP RSS/RO.","youtube":"https://www.youtube.com/watch?v=VIDEO1"}
  },
  {
    "id":"apollo8_recreation",
    "type":"keplerian",
    "centralBody":"moon",
    "epoch": 1737176400,
    "a": 1838000,
    "e": 0.05,
    "i": 1.5 * Math.PI/180,
    "raan": 0,
    "argPeri": 0,
    "M0": 0,
    "info":{"name":"Apollo 8 Recreation","description":"First crewed mission to orbit the Moon.","youtube":"https://www.youtube.com/watch?v=VIDEO2"}
  }
];

// --- Scene setup ---
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 1e8);
camera.position.set(0,0,1.2e7);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const controls = new THREE.OrbitControls(camera, renderer.domElement);

// --- Lights ---
const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
scene.add(ambientLight);
const dirLight = new THREE.DirectionalLight(0xffffff, 0.4);
dirLight.position.set(5e6,5e6,5e6);
scene.add(dirLight);

// --- Global variables ---
let currentPlanet = 'earth';
let planetMesh;
let vesselSprites = [];
let orbitLines = [];
let labels = [];

// --- Planet creation ---
function createPlanet(name){
  if(planetMesh) scene.remove(planetMesh);
  const texture = new THREE.TextureLoader().load(planetTextures[name]);
  const radius = name==='moon'?1737e3: name==='earth'?6371e3:3390e3;
  const material = new THREE.MeshStandardMaterial({map:texture});
  planetMesh = new THREE.Mesh(new THREE.SphereGeometry(radius,64,64), material);
  scene.add(planetMesh);

  // remove old vessels/orbits/labels
  vesselSprites.forEach(v=>scene.remove(v.mesh));
  orbitLines.forEach(l=>scene.remove(l));
  labels.forEach(l=>l.remove());
  vesselSprites=[]; orbitLines=[]; labels=[];

  // add vessels of this planet
  vessels.filter(v=>v.centralBody===name).forEach(v=>{
    // sprite vessel
    const spriteMat = new THREE.SpriteMaterial({color:0xffffff, depthTest:false});
    const sprite = new THREE.Sprite(spriteMat);
    sprite.renderOrder=999;
    scene.add(sprite);
    vesselSprites.push({mesh:sprite, data:v});

    // label
    const div = document.createElement('div');
    div.className='label';
    div.innerText=v.info.name;
    document.body.appendChild(div);
    labels.push(div);

    // orbit
    const steps=256;
    const points=[];
    for(let j=0;j<=steps;j++){
      const M = 2*Math.PI*j/steps;
      points.push(keplerToCartesian(v.a,v.e,v.i,v.raan,v.argPeri,M));
    }
    const lineGeom = new THREE.BufferGeometry().setFromPoints(points);
    const lineMat = new THREE.LineBasicMaterial({color:0xffffff, transparent:true, opacity:0.4});
    const line = new THREE.Line(lineGeom, lineMat);
    scene.add(line);
    orbitLines.push({line:line, points:points});
  });
}
createPlanet(currentPlanet);

// --- Planet selector ---
document.getElementById('planetDropdown').addEventListener('change', e=>{
  currentPlanet = e.target.value;
  createPlanet(currentPlanet);
});

// --- Keplerian -> Cartesian ---
function keplerToCartesian(a,e,i,raan,argPeri,M){
  const E = M; // crude approx
  let x = a*(Math.cos(E)-e);
  let y = a*a*Math.sqrt(1-e*e)*Math.sin(E)/a;
  let z = 0;
  // argPeri
  const cosAP=Math.cos(argPeri), sinAP=Math.sin(argPeri);
  let x1=x*cosAP - y*sinAP, y1=x*sinAP + y*cosAP, z1=z;
  // inclination
  const cosI=Math.cos(i), sinI=Math.sin(i);
  let x2=x1, y2=y1*cosI - z1*sinI, z2=y1*sinI + z1*cosI;
  // RAAN
  const cosR=Math.cos(raan), sinR=Math.sin(raan);
  let xf=x2*cosR - y2*sinR, yf=x2*sinR + y2*cosR, zf=z2;
  return new THREE.Vector3(xf,yf,zf);
}

// --- Animation ---
function animate(){
  requestAnimationFrame(animate);

  // slow planet rotation
  const dt = 1/60;
  if(currentPlanet==='earth') planetMesh.rotation.y += (2*Math.PI)/(24*60*60)/60;
  if(currentPlanet==='moon') planetMesh.rotation.y += (2*Math.PI)/(27.3*24*60*60)/60;
  if(currentPlanet==='mars') planetMesh.rotation.y += (2*Math.PI)/(24.6*60*60)/60;

  // update vessels
  vesselSprites.forEach((v,i)=>{
    const pos = keplerToCartesian(v.data.a,v.data.e,v.data.i,v.data.raan,v.data.argPeri,v.data.M0);
    v.mesh.position.copy(pos);

    // constant screen size
    const scale = 15 * (camera.position.distanceTo(pos)/1e7);
    v.mesh.scale.set(scale,scale,1);

    // update label position
    const vector = pos.clone().project(camera);
    const x = (vector.x*0.5+0.5)*window.innerWidth;
    const y = (-vector.y*0.5+0.5)*window.innerHeight;
    labels[i].style.transform = `translate(-50%,-150%) translate(${x}px,${y}px)`;
  });

  // orbit line fade
  orbitLines.forEach((o,i)=>{
    const lineGeom = o.line.geometry;
    const pos = vesselSprites[i].mesh.position;
    const positions = lineGeom.attributes.position.array;
    const newAlpha = new Float32Array(positions.length/3);
    for(let j=0;j<positions.length;j+=3){
      const dx=positions[j]-pos.x;
      const dy=positions[j+1]-pos.y;
      const dz=positions[j+2]-pos.z;
      const dist=Math.sqrt(dx*dx+dy*dy+dz*dz);
      newAlpha[j/3] = Math.min(1,dist/1e6);
    }
    o.line.material.opacity=0.4; // always visible
  });

  document.getElementById('utcTime').textContent = new Date().toISOString().replace('T',' ').replace('Z',' UTC');
  controls.update();
  renderer.render(scene, camera);
}
animate();

// --- Vessel click panel ---
renderer.domElement.addEventListener('pointerdown', e=>{
  const mouse = new THREE.Vector2();
  mouse.x = (e.clientX/window.innerWidth)*2-1;
  mouse.y = -(e.clientY/window.innerHeight)*2+1;
  const raycaster = new THREE.Raycaster();
  raycaster.setFromCamera(mouse, camera);
  const intersects = vesselSprites.filter(v=>raycaster.intersectObject(v.mesh).length>0);
  if(intersects.length>0){
    const v = intersects[0].data;
    document.getElementById('vesselName').innerText = v.info.name;
    document.getElementById('vesselDesc').innerText = v.info.description;
    const yt = document.getElementById('vesselYT');
    yt.href=v.info.youtube;
    yt.style.display='block';
    document.getElementById('infoPanel').style.display='block';
  }
});

window.addEventListener('resize', ()=>{
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
